# NOTE: on windows, there's a very strange set of build issues.
#     If you run the VS2008 build, you need to do so as a normal user, or else you get permission errors on the TEMP folder.
#     If you run the VS2015 build, you need to run it from an elevated prompt, or else you get errors like:
#           C:\Program Files
#           (x86)\MSBuild\Microsoft\VisualStudio\v14.0\CodeAnalysis\Microsoft.CodeAnalysis.targets(219,5):
#           error MSB4036: The "SetEnvironmentVariable" task was not found.
#           Check the following: 1.) The name of the task in the project file is
#           the same as the name of the task class. 2.) The task class is
#           "public" and implements the Microsoft.Build.Framework.ITask
#           interface. 3.) The task is correctly declared with <UsingTask> in
#           the project file, or in the *.tasks files located in the "C:\Program
#           Files (x86)\MSBuild\14.0\bin" directory.
#           [C:\ci\libdb_1537814475445\work\build_windows\VS10\db.vcxproj]
schema_version: 1

context:
  version: 6.2.32

recipe:
  name: libdb
  version: ${{ version }}

source:
  url: http://download.oracle.com/berkeley-db/db-${{ version }}.tar.gz
  sha256: a9c5e2b004a5777aa03510cfe5cd766a4a3b777713406b02809c17c8e0e7a8fb
  patches:
    # fixes atomic issue on clang, see https://trac.macports.org/ticket/53577#no1
    - if: osx
      then: src_dbinc_atomic.h.patch

build:
  number: 0

requirements:
  build:
    - if: unix
      then: make
    - if: unix
      then: gnuconfig
    - ${{ compiler('c') }}
    - ${{ compiler('cxx') }}
  host:

outputs:
  - package:
      name: libdb
    build:
    requirements:
      run_exports:
        - ${{ pin_subpackage("libdb", upper_bound="x.x") }}
    tests:
      - script:
          - if: unix
            then: test -f ${PREFIX}/lib/libdb${SHLIB_EXT}
          - if: win
            then: if not exist %LIBRARY_BIN%\libdb%SHLIB_EXT%
  # metapackage for old anaconda name (only available on linux/mac)
  - package:
      name: db
    requirements:
      build:
        # compilers are to ensure that variants are captured
        - ${{ compiler('c') }}
        - ${{ compiler('cxx') }}
      run:
        - ${{ pin_subpackage('libdb', exact=True) }}
    tests:
      - script:
          - db_archive -m hello

about:
  license: AGPL-3.0-only
  license_file: LICENSE
  summary: The Berkeley DB embedded database system.
  homepage: http://www.oracle.com/technology/software/products/berkeley-db/index.html

extra:
  recipe-maintainers:
    - ocefpaf
    - scopatz
    - mingwandroid
    - msarahan

