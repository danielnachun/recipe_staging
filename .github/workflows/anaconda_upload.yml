name: Upload conda packages to anaconda.org

on:
  pull_request:
    types: [closed]

jobs:
  upload:
    if: github.event.pull_request.merged == true 
    runs-on: ubuntu-latest
    env:
      ANACONDA_API_TOKEN: ${{ secrets.ANACONDA_API_TOKEN }}

    steps:
      - uses: actions/checkout@v3

      - name: Get changed directories
        id: changed-directories
        uses: tj-actions/changed-files@v35
        with: 
          dir_names_exclude_root: true
          files_ignore_from_source_file: .github/*

      - name: Environment variables
        if: steps.changed-directories.outputs.any_changed_files == true
        shell: bash
        run: |
          ARTIFACTS_SHA=$(git rev-parse HEAD)
          BUILD_ARTIFACTS=Artifacts_${ARTIFACTS_SHA}
          echo "BUILD_ARTIFACTS=$BUILD_ARTIFACTS" >> $GITHUB_ENV

      - name: Download packages
        if: steps.changed-directories.outputs.any_changed_files == true
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: conda_mambabuild.yml
          name: ${{ env.BUILD_ARTIFACTS }}
          path: artifacts

      - name: Set up container with Anaconda client
        if: steps.changed-directories.outputs.any_changed_files == true
        run: |
          docker run --rm --detach \
            --name ${{github.sha}} \
            --workdir /home/conda/packages \
            --volume $(pwd)/artifacts:/home/conda/artifacts \
            condaforge/mambaforge \
            sleep inf

      - name: Install boa
        if: steps.changed-directories.outputs.any_changed_files == true
        run: docker exec ${{github.sha}} mamba install --yes --quiet anaconda-client

      - name: Upload packages
        if: steps.changed-directories.outputs.any_changed_files == true
        run: |
          docker exec -e ANACONDA_API_TOKEN=${ANACONDA_API_TOKEN} \
            ${{github.sha}} \
            /usr/bin/env bash -c "anaconda upload --force /home/conda/artifacts/*.tar.bz2"
